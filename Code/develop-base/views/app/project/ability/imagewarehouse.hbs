<style>
    body {
    background-color: #f1f2f7;
    }

    .clearfix:after {
    content: ".";
    display: block;
    height: 0;
    visibility: hidden;
    clear: both;
    }

    .left-nav {
    width: 16%;
    background-color: #ccc;
    height: 800px;
    float: left;
    }

    .main {
    width: 84.5%;
    padding: 1%;

    float: left;
    }

    @media (max-width: 1440px) {
    .main .box {
    width: 24%;
    /*显示四个*/
    }
    }

    @media (min-width: 1441px) {
    .main .box {
    width: 18.9%;
    /*显示6个*/
    }
    }

    .main .box {
    float: left;
    height: 250px;
    background-color: #ffffff;
    margin-right: 1%;
    margin-bottom: 15px;
    box-sizing: border-box;
    border: 1px solid #e9eaf0;
    padding: 15px;
    position: relative;
    }

    .name-box img {
    float: left;
    width: 25%;
    }

    .name-box h3 {
    float: right;
    font-size: 14px;
    font-weight: bold;
    color: #777777;
    width: 70%
    }

    .name-box span {
    width: 70%;
    display: inline-block;
    font-size: 12px;
    color: #bbbbbb;
    float: right;
    text-align: justify;
    }

    .miaoshu {
    margin-top: 10px;
    font-size: 12px;
    line-height: 20px;
    color: #828282;
    text-align: justify;
    height: 100px;
    overflow: hidden;
    }
    .image-type {
        margin-top: 5px;
        margin-left: 5px;
        font-size: 12px;
        line-height: 20px;
        color: #828282;
        text-align: justify;
        overflow: hidden;
    }

    .box-bottom {
        position: absolute;
        left: 0;
        bottom: 10px;
        width: 100%;
    }

    .box-bottom a {
        font-size: 12px;
        text-decoration: none;
        float: right;
        display: inline-block;
        margin-left: 10px;
        margin-right: 25px;
        color: #828282;
    }
</style>
<script src="{{projcfg.appurl}}/static/js/containerlistingdata.js" type="text/javascript"></script>
<style>
    .div-bor{
        position: relative;width: 100%;height: 35px;
        border-bottom: 1px solid #ccc;
        margin-bottom: 1rem;
    }
    .icon-serach{
        position: absolute;left: 0;z-index:5;
        background-image: url('{{projcfg.appurl}}/static/images/search.png'); /*引入图片图片*/
        background-repeat: no-repeat; /*设置图片不重复*/
        background-position: 1px 0px; /*图片显示的位置*/
        width: 20px; /*设置图片显示的宽*/
        height: 20px; /*图片显示的高*/
        top: 5px;
        left: 3px;
        cursor:pointer;
    }
    .serach{
        padding-left: 22px;
    }
    input[type=radio] {
         opacity: 1;
         position: relative;
         left: 2px;
         z-index: 12;
         width: 13px;
         height: 13px;
         cursor: pointer;
         margin: 1rem;
    }

</style>
<div class="row">
    <div class="col-xs-12 col-md-12">
        <div class="widget">
            <div class="widget-body">
                <div id="toolbar" class="row tbRow" style="margin-bottom: 1.1rem;border-bottom: 1px solid #ccc;">
                    <div class="col-xs-6 col-md-6" style="width:100%">
                        <font size="3.5rem" style="margin-left: 1.2rem;margin-right: 2.5rem"> <b>镜像仓库</b></font>
                        <div class="btn-group" role="group" aria-label="...">
                            <button type="button" class="btn btn-default" onclick="do_page('myimage')" data-title="我的镜像">
                                <i class="fa fa-edit"></i> 我的镜像
                            </button>
                            <button type="button" class="btn btn-default" onclick="do_page('favorites')" data-title="收藏夹">
                                <i class="fa fa-edit"></i> 收藏夹
                            </button>
                            <button type="button" class="btn btn-default" onclick="do_page('privateimage')" data-title="私有镜像">
                                <i class="fa fa-edit"></i> 私有镜像
                            </button>
                        </div>

                    </div>
                </div>
                <div id="cc" class="easyui-layout" data-options="fit:true,border:false" style="width: 800px; height:575px;background-color: #fbfbfb;">
                    <div id="images" data-options="region:'center',border:false" style="overflow-x:hidden;overflow-y:hidden">
                        <div id="datagridPanel" style="width:100%;height: 100%;">
                            <table id="myImageDataTable">
                            </table>
                        </div>
                        <div id="privatediv" style="width:100%;height: 100%;display:none;">
                            <div style="border-right:1px solid #ccc;width:15%;height:100%;float:left;">
                                <div class="div-bor">
                                    <i class="icon-serach"></i>
                                    <input type="text" class="serach" placeholder="搜索镜像"/>
                                </div>
                                <div style="margin: 1rem;">
                                    <ul>
                                        <li>分类 <div style="float: right;cursor: pointer;" onclick="cleanRadioValue();">清空</div></li>
                                        <li><input name="types" type="radio" value="db" />数据库</li>
                                        <li><input name="types" type="radio" value="tool" />运维工具</li>
                                        <li><input name="types" type="radio" value="mq" />消息队列</li>
                                        <li><input name="types" type="radio" value="pl" />编程语言</li>
                                        <li><input name="types" type="radio" value="service" />服务器</li>
                                        <li><input name="types" type="radio" value="web" />web框架</li>
                                        <li><input name="types" type="radio" value="sys" />操作系统</li>
                                    </ul>
                                </div>
                            </div>

                            <div id="privateImageDiv" class="main"  >

                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
<div>

</div>

<script  type="text/javascript">
    $(function(){
        $(":radio").click(function(){
            showPrivateImages('privateimage',$(this).val());
        });
        $('#myImageDataTable').datagrid({
            url:'{{projcfg.appurl}}/api/project/ability/imagewarehouse/develop/im/pageList',
            method:'get',
            queryParams:{"flag":"myimage"},
            striped:true,
            fitColumns:true,
            fit:true,
            border:true,
            singleSelect:true,
            selectOnCheck:false,
            columns:[[
                // {"field": "imageCode", checkbox:true},
                {"field": "imageCode","title":"编号","width":80,align:"center"},
                {"field": "imageName","title":"镜像源","width":150,align:"center"},
                {"field": "version","title":"版本","width":100,align:"center","formatter":function(value,rowData,rowIndex){
                    return getVerData(rowData.imageCode,rowIndex);
                }},
                {"field": "createDate","title":"创建时间","width":100,align:"center"},
                {"field": "remark","title":"备注","width":200,align:"center"},
                {"field": "options","title":"操作","width":150,align:"center","formatter":function (value, rowData,rowIndex) {
                    return "<a  href='javascrip:void(0);'> 删除 </a>| <a href='javascrip:void(0);'>日志</a> ";
                }}
            ]],
            onLoadError:function() {
                msgError('加载数据出现时发生错误,请稍候重试...');
            },
            pagination:true,
            loadMsg:'正在加载...'
        });
    });

    function cleanRadioValue(){
        $('input:radio[name=types]').attr('checked',false);
        showPrivateImages('privateimage','');
    }
    //显示加载私有镜像
    function showPrivateImages(flag,type){
        $.ajax({
            url: '{{projcfg.appurl}}/api/project/ability/imagewarehouse/develop/im/pageList',
            type: 'get',
            data:{"page":1,"rows":6,"flag":flag,'type':type},
            success: function (data) {
                var html_div='';
                var rows=data.rows;
                if(data.total > 0 ) {
                    $("#privateImageDiv").empty();
                    for(var i=0;i<rows.length;i++){
                        html_div+='<div  class="box">' +
                                '<div class="name-box clearfix">'+
                                '<img src="data:'+rows[i].pictureType+';base64 ,'+rows[i].picture+'"'+'alt="">'+
                                '<h3>'+rows[i].imageName+'</h3>'+
                                ' <span> '+rows[i].channels+'</span>'+
                                '</div>'+
                                '<p class="miaoshu">'+rows[i].simpleIntroduction+'</p>'+
                                '<p class="image-type">'+rows[i].catagory+'</p>'+
                                '<div class="box-bottom"><a href=""><img src="{{projcfg.appurl}}/static/images/download.png""></img>'+rows[i].downloadNumber+'</a>'+
                                '<a href=""><img src="{{projcfg.appurl}}/static/images/soucang.png""></img>'+rows[i].collectionNumber+'</a></div></div>'

                    }
                    $("#privateImageDiv").append(html_div);
                }
                else {
                    msgError(data.msg+',错误代码:'+data.code);
                }
            }
        });
    }

    function do_page(flag){
        $('#myImageDataTable').datagrid('loadData', { total: 0, rows: [] });
        if(flag && flag == "myimage"){
            $("#privatediv").hide();
            $("#datagridPanel").show();
            $("#myImageDataTable").datagrid({
                url:'{{projcfg.appurl}}/api/project/ability/imagewarehouse/develop/im/pageList',
                method:'get',
                queryParams:{"flag":flag},
                rownumbers:false,
                striped:true,
                fitColumns:true,
                fit:true,
                border:true,
                singleSelect:true,
                selectOnCheck:false,
                columns:[[
                    // {"field": "imageCode", checkbox:true},
                    {"field": "imageCode","title":"编号","width":80,align:"center"},
                    {"field": "imageName","title":"镜像源","width":150,align:"center"},
                    {"field": "imageVersion","title":"版本","width":100,align:"center","formatter":function(value,rowData,rowIndex){
                        return getVerData(rowData.imageCode,rowIndex);
                    }},
                    {"field": "createDate","title":"创建时间","width":100,align:"center",'formatter':function(value, rowData,rowIndex){
                        if(value){
                            var start_time=Date.parse(value);
                            var end_time=new Date();
                            var time=end_time-start_time;
                            //计算出相差天数
                            var days=Math.floor(time/(24*3600*1000))
                            //计算出小时数
                            var leave1=time%(24*3600*1000) ;
                            //计算天数后剩余的毫秒数
                            var hours=Math.floor(leave1/(3600*1000))
                            //计算相差分钟数
                            var leave2=leave1%(3600*1000)
                            //计算小时数后剩余的毫秒数
                            var minutes=Math.floor(leave2/(60*1000))
                            //计算相差秒数
                            var leave3=leave2%(60*1000)
                            //计算分钟数后剩余的毫秒数
                            var seconds=Math.round(leave3/1000)
                            if(days>0){
                                return days+"天"+hours+'时'+minutes+'分'+seconds+'秒前';

                            }else{
                                if(hours>0){
                                    return hours+'时'+minutes+'分'+seconds+'秒前';
                                }else{
                                    if(minutes>0){
                                        return minutes+'分'+seconds+'秒前';
                                    }else{
                                        if(seconds>0){
                                            return seconds+'秒前';
                                        }
                                    }
                                }
                            }
                        }

                    }},
                    {"field": "remark","title":"备注","width":200,align:"center"},
                ]],
                onLoadError:function() {
                    msgError('加载数据出现时发生错误,请稍候重试...');
                },
                pagination:true,
                loadMsg:'正在加载...'
            });

//            $('#myImageDataTable').datagrid('loadData',mydockerdata);
        }else if(flag && flag == "favorites"){
            $("#privatediv").hide();
            $("#datagridPanel").show();
            $('#myImageDataTable').datagrid({
                url:'{{projcfg.appurl}}/api/project/ability/imagewarehouse/develop/im/pageList',
                method:'get',
                queryParams:{"flag":flag},
                rownumbers:false,
                striped:true,
                fitColumns:true,
                fit:true,
                border:true,
                singleSelect:true,
                selectOnCheck:false,
                columns:[[
                    {"field": "imageCode","title":"编号","width":80,align:"center","formatter":function (value, rowData,rowIndex) {
                        return rowData.imageCode;
                    }},
                    {"field": "imageName","title":"镜像源","width":150,align:"center"},
                    {"field": "imageVersions","title":"版本","width":100,align:"center","formatter":function(value,rowData,rowIndex){
                        return getVerData(rowData.imageCode,rowIndex);
                    }},
                    {"field": "createDate","title":"创建时间","width":100,align:"center"},
                    {"field": "remark","title":"备注","width":200,align:"center"},
                    {"field": "options","title":"操作","width":150,align:"center","formatter":function (value, rowData,rowIndex) {
                        return " 部署应用 ";
                    }}
                ]],
                onLoadError:function() {
                    msgError('加载数据出现时发生错误,请稍候重试...');
                },
                pagination:true,
                loadMsg:'正在加载...'
            });
        }else if(flag && flag == "privateimage"){
            $("#datagridPanel").hide();
            showPrivateImages(flag,'');
            $("#privatediv").show();
        }
    }
    function getVerData(imageCode,rowIndex){
        var flag = "vers"+rowIndex;
        var select = "<select id=\""+flag+"\" class=\"easyui-combobox\" name=\""+flag+"\" style=\"width:130px;\">";
        if(imageCode){
            $.ajax({
                url: '{{projcfg.appurl}}/api/project/ability/imagemanage/develop/im/verList',
                type: 'get',
                async:false,
                data: {'imageCode':imageCode},
                success: function (data) {
                    console.log(data);
                    if(data.success) {
                        var verdata = verAarry(data.data);
                        console.log("==",verdata);
                        for(var i=0;i<verdata.length;i++){
                            select += "<option value='"+verdata[i]+"'>"+verdata[i]+"</option>";
                        }
                    }
                    else {
                        msgError(data.msg+',错误代码:'+data.code);
                    }
                }
            });
        }
        select +=  '</select>';
        return select;
    }

    function verAarry(data){
        var arr = [];
        for(var i=0;i<data.length;i++){
            arr.push(data[i].imageVersion);
        }
        //进行倒序排序
        arr.sort(function(o1,o2){
            var a1 = o1.replace('v','').split('.');
            var a2 = o2.replace('v','').split('.');
            var length = Math.max(a1.length,a2.length);
            for(var i = 0; i < length; i++){
                var n1 = parseInt(a1[i] || 0);
                var n2 = parseInt(a2[i] || 0);
                if(n1 - n2 != 0){
                    return n2 - n1;
                }
            }
        });
        return arr;
    }


//    // 打开页面
//    function openPage(title, value, callback) {
//        $('#myModal').show();
//        $('#myModal').mydialog({
//            title:title,
//            width: 700,
//            height: 485,
//            top:100,
//            modal: true,
//            myButtons:[
//                {
//                    text:'确定',
//                    btnCls:'btn btn-blue',
//                    handler:function(){
//                        callback(value);
//                    }
//                },
//                {
//                    text:'关闭',
//                    btnCls:'btn btn-danger',
//                    handler:function(){
//                        closeDialog();
//                    }
//                }
//            ]
//        });
//    }
//
//    // 清空新增表单数据
//    function clear() {
//        $('#projectForm').form('clear');
//    }
//
//    // 关闭窗口
//    function closeDialog() {
//        $('#myModal').dialog('close');
//        clear();
//    }

</script>